{% extends "layout.html" %}

{% set defDSP = ['Недошліфовка','Білі плями','Гофри','Раковини','Заовалення','Розслоєння','Тріщини','Прошліфовка','Білі крапки','Груба фракція'] %}

{% block scripts %}
    <script>
        const koef = 0.08052;
        kk = {{rob_zm|tojson|safe}};

        function calculate_p_size(el)
        {
            calculate_size(el, "p");
            sum = calculate_perc(el, "plyta_q");

            n = document.querySelector("td[class="+tekst+"] input[class=zquantity]");
            n.value = sum / 2;
            calculate_size(n, "z");

            sum1s(el.className.slice(-8,-5), el.className.slice(-3,-1));
            sum_p(el.className.slice(-12,-10), el.className.slice(-3,-1));
        }

        function calculate_size(el, pos)
        {   
            if (pos == "z")
            {
                qEl = el.parentNode.parentNode.querySelector("input[class=i_z_size]");
                k = koef * 2;
            }
            if (pos == "p")
            {
                qEl = el.parentNode.parentNode.querySelector("input[class=i_p_size]");
                k = koef;
            }

            if (el.value != 0)
            {
                qEl.value = valRound4(el.value * k);
            } 
            else
            {
                qEl.value = "";
            }
        }

        function calculate_perc(el, pl)
        {
            tekst = el.parentNode.parentNode.className;
            n = document.querySelectorAll("."+tekst+"i."+pl); // all in column
            sum = sumVal(n);

            for (let elem of n)
            {
                if (sum > 0)
                { v = Math.round(elem.value / sum * 100) + "%";
                }
                else {
                    v = "";
                }
                elem.parentNode.parentNode.querySelector("input[class=i_p_perc]").value = v;
            }
            return sum;
        }

        function calculate_perc_1s(sum_1s, pr, e)
        {
            n = document.querySelectorAll("."+pr+"i."+e+"i.plyta_q");
            sumt = sumVal(n);
            if (sumt == 0)
            {
                res = "";
            }
            else
            {
                res = Math.round(sum_1s / sumt * 100) + "%";
            }
            return res;           
        }

        function pl_q_change()
        {
            calculate_p_size(event.target, "p");
        }

        function z_q_change()
        {
            calculate_size(event.target, "z");
        }

        
        function plyta_tot_change(s, e)
        {
            el = document.querySelector(".plyta_zm."+s+"i."+e+"i");
            calculate_size(el, "p");
            calculate_perc(el, "plyta_tot");
        }
       
            /* 
            let elements = document.querySelectorAll('ul > li:last-child');
            for (let elem of elements) {
                alert(elem.innerHTML); // "test", "passed"
            }

            [].indexOf.call(plytaInput, document.querySelector("input[id=t1s1i]"))
            */

        function valRound4(i)
        {
            return Math.round((i + Number.EPSILON) * 10000) / 10000
        }

        function sumVal(lst)
        {
            sum=0;
            for (i=0;i<lst.length;i++)
             {
                 if (lst[i].value != "")
                 {
                    sum += parseInt(lst[i].value);
                }
            }
            return sum;
        }

        function test()
        {   
            alert(totValues);
            
        }

        function make_total_global(){
            z = document.querySelector(".zquantity.tot7i").value * 2;
            m = document.querySelector(".zquantity.tot9i").value * 2;
            totValues = [z, m];
        }

        function calc_sum1s()
        {
            el = event.target;

        }

        function sum1s(pr, e)
        {   
            n = document.querySelectorAll(".s1i."+pr+"i."+e+"i.plyta_q");
            sum = sumVal(n);    // sum 1 sort
            document.querySelector(".total_i."+pr+"i."+e+"i").value = sum/2;
            document.querySelector(".size_i."+pr+"i."+e+"i").value = valRound4(sum * koef);
            // percent
            document.querySelector(".perc_i."+pr+"i."+e+"i").value = calculate_perc_1s(sum, pr, e);

        }

        function sum_p(s, e)
        {
            n = document.querySelectorAll("."+s+"i."+e+"i.plyta_q");
            sum = sumVal(n);
            el = document.querySelector(".plyta_zm."+s+"i."+e+"i");
            el.value = sum;
            plyta_tot_change(s,e);
            sum_t(e, el.className.slice(-13,-9));

            // Разом
            n = document.querySelectorAll(".plyta_zm."+s+"i:not(.e3i)");
            sum = sumVal(n);
            el = document.querySelector(".plyta_zm."+s+"i.e3i");
            el.value = sum;
            calculate_size(el, "p");
            calculate_perc(el, "plyta_tot");
            sum_t("e3", el.className.slice(-13,-9));
            // порахувати за добу
            // порахувати за місяць
            
        }

        function sum_t(e, t)
        {   
            n = document.querySelectorAll(".plyta_tot."+t+"i");
            sum = sumVal(n);
            el = document.querySelector("."+e+"i."+t+"i.zquantity");
            el.value = sum/2;
            calculate_size(el, "z");
            make_total_global();
        }

        function listen()
        {
            window.totValues;
            //var el = document.querySelector("div.user-panel.main input[name=login]")
            window.plytaInput = document.querySelectorAll(".plyta_q");
            
            // test label
            document.querySelector("label[class=testClick]").addEventListener("click",test,false);

            //document.querySelector(".total_i").addEventListener("change", calc_sum1s, false);

            for(let i=0; i<plytaInput.length;i++)
            {   
                calculate_p_size(plytaInput[i]);
                plytaInput[i].addEventListener("change", pl_q_change, false);
            }  
        }

        document.addEventListener('DOMContentLoaded', listen);


    </script>
{% endblock scripts %}

{% block body %}
    <input type="date" id="zm_date" value="2021-01-01">
    <label class="testClick">Click</label>
    <h2>Назва таблиці</h2>
    <p></p>
    <table id="main_table">  
        <tr id="row_header">
            <th colspan="2" rowspan="2">Випуск продукції</th>
            <th colspan="7">Прес1</th>
            <th colspan="7">Прес2</th>
            <th colspan="3" rowspan="3">Всього Е1</th>
            <th colspan="3" rowspan="3">Всього Е05</th>
            <th colspan="3" rowspan="3">Разом</th>
        </tr>
        <tr id="row_E">
            <th colspan="4">Е1</th>
            <th colspan="3">Е05</th>
            <th colspan="4">Е1</th>
            <th colspan="3">Е05</th>
        </tr>
        <tr id="pidsumok">
            <td colspan="2">підсумок</td>
            <td><input type="text" class="pr1i e1i total_i" size="7" readonly></td>
            <td><input type="text" class="pr1i e1i size_i" size="7" readonly></td>
            <td><input type="text" class="pr1i e1i perc_i" size="7" readonly></td>
            <td></td>
            <td><input type="text" class="pr1i e2i total_i" size="7" readonly></td>
            <td><input type="text" class="pr1i e2i size_i" size="7" readonly></td>
            <td><input type="text" class="pr1i e2i perc_i" size="7" readonly></td>
            <td><input type="text" class="pr2i e1i total_i" size="7" readonly></td>
            <td><input type="text" class="pr2i e1i size_i" size="7" readonly></td>
            <td><input type="text" class="pr2i e1i perc_i" size="7" readonly></td>
            <td></td>
            <td><input type="text" class="pr2i e2i total_i" size="7" readonly></td>
            <td><input type="text" class="pr2i e2i size_i" size="7" readonly></td>
            <td><input type="text" class="pr2i e2i perc_i" size="7" readonly></td>
        </tr>
        <tr>
            <td colspan="2">Текстури</td>
            {% for i in range(1,15) %}
                <td><input type="text" name="texture" value="{{i}}" size="7"></td>
            {% endfor %}
            {% for i in range(3) %}
            <td><input type="text" class="txt" size="7" value="За зміну" readonly></td>
            <td><input type="text" class="txt" size="7" value="За добу" readonly></td>
            <td><input type="text" class="txt" size="7" value="За місяць" readonly></td>
            {% endfor %}
        </tr>
        <tr id="s1">
            <td class='plyta'>Плита 1 сорт</td>
            <td><div>шт</div><div>м3</div><div>%</div></td>
            {% for i in range(1,5) %}
            <td class="t{{i}}"><div><input type="text" name="t{{i}}" class="plyta_q t{{i}}i s1i pr1i e1i" value="" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
            {% for i in range(5,8) %}
            <td class="t{{i}}"><div><input type="text" name="t{{i}}" class="plyta_q t{{i}}i s1i pr1i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
            {% for i in range(8,12) %}
            <td class="t{{i}}"><div><input type="text" name="t{{i}}" class="plyta_q t{{i}}i s1i pr2i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
            {% for i in range(12,15) %}
            <td class="t{{i}}"><div><input type="text" name="t{{i}}" class="plyta_q t{{i}}i s1i pr2i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
            {% for i in range(3) %}
            <td class="tot{{i*3+1}}"><div><input type="text" class="plyta_zm plyta_tot tot{{i*3+1}}i s1i e{{i+1}}i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot{{i*3+2}}"><div><input type="text" class="plyta_dob plyta_tot tot{{i*3+2}}i s1i e{{i+1}}i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot{{i*3+3}}"><div><input type="text" class="plyta_mis plyta_tot tot{{i*3+3}}i s1i e{{i+1}}i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
        </tr>
        <tr id="s2">
            <td class='plyta'>Плита 2 сорт</td>
            <td><div>шт</div><div>м3</div><div>%</div></td>
            {% for i in range(1,5) %}
            <td class="t{{i}}"><div><input type="text" name="t{{i}}" class="plyta_q t{{i}}i s2i pr1i e1i" value="" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
            {% for i in range(5,8) %}
            <td class="t{{i}}"><div><input type="text" name="t{{i}}" class="plyta_q t{{i}}i s2i pr1i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
            {% for i in range(8,12) %}
            <td class="t{{i}}"><div><input type="text" name="t{{i}}" class="plyta_q t{{i}}i s2i pr2i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
            {% for i in range(12,15) %}
            <td class="t{{i}}"><div><input type="text" name="t{{i}}" class="plyta_q t{{i}}i s2i pr2i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
            {% for i in range(3) %}
            <td class="tot{{i*3+1}}"><div><input type="text" class="plyta_zm plyta_tot tot{{i*3+1}}i s2i e{{i+1}}i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot{{i*3+2}}"><div><input type="text" class="plyta_dob plyta_tot tot{{i*3+2}}i s2i e{{i+1}}i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot{{i*3+3}}"><div><input type="text" class="plyta_mis plyta_tot tot{{i*3+3}}i s2i e{{i+1}}i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
        </tr>
        <tr id="s3">
            <td class='plyta'>Плита 3 сорт</td>
            <td><div>шт</div><div>м3</div><div>%</div></td>
            {% for i in range(1,5) %}
            <td class="t{{i}}"><div><input type="text" name="t{{i}}" class="plyta_q t{{i}}i s3i pr1i e1i" value="" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
            {% for i in range(5,8) %}
            <td class="t{{i}}"><div><input type="text" name="t{{i}}" class="plyta_q t{{i}}i s3i pr1i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
            {% for i in range(8,12) %}
            <td class="t{{i}}"><div><input type="text" name="t{{i}}" class="plyta_q t{{i}}i s3i pr2i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
            {% for i in range(12,15) %}
            <td class="t{{i}}"><div><input type="text" name="t{{i}}" class="plyta_q t{{i}}i s3i pr2i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
            {% for i in range(3) %}
            <td class="tot{{i*3+1}}"><div><input type="text" class="plyta_zm plyta_tot tot{{i*3+1}}i s3i e{{i+1}}i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot{{i*3+2}}"><div><input type="text" class="plyta_dob plyta_tot tot{{i*3+2}}i s3i e{{i+1}}i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot{{i*3+3}}"><div><input type="text" class="plyta_mis plyta_tot tot{{i*3+3}}i s3i e{{i+1}}i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            {% endfor %}
        </tr>
        <tr id="row_zapr">
            <td class='plyta'>Всього </td>
            <td><div>запр</div><div>м3</div></td>
            {% for i in range(1,15) %}
            <td class="t{{i}}"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            {% endfor %}
            {% for i in range(3) %}
            <td class="tot{{i*3+1}}"><div><input class="zquantity tot{{i*3+1}}i e{{i+1}}i" value="" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="tot{{i*3+2}}"><div><input class="zquantity tot{{i*3+2}}i e{{i+1}}i" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="tot{{i*3+3}}"><div><input class="zquantity tot{{i*3+3}}i e{{i+1}}i" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            {% endfor %}
        </tr>
    </table>

    <p>&nbsp;</p>

    <table id="descr_table">
        <tr>
            <td colspan="2">Дата ДСП</td>
            {% for i in range(1,15) %}
            <td><input type="text" name="t{{i}}" class="table2i t{{i}}i" size="7"></td>
            {% endfor %}
        </tr>
        <tr>
            <td colspan="2">Витримка в пресі</td>
            {% for i in range(1,15) %}
            <td><input type="text" name="t{{i}}" class="table2i t{{i}}i" size="7"></td>
            {% endfor %}
        </tr>
        <tr>
            <td rowspan="2">Температура</td>
            <td>t верх</td>
            {% for i in range(1,15) %}
            <td><input type="text" name="t{{i}}" class="table2i t{{i}}i" size="7"></td>
            {% endfor %}
        </tr>
        <tr>
            <td>t низ</td>
            {% for i in range(1,15) %}
            <td><input type="text" name="t{{i}}" class="table2i t{{i}}i" size="7"></td>
            {% endfor %}
        </tr>
    </table>

    <p>&nbsp;</p>

    <table id="defekt_table">
        <tr>
            <td colspan="16" rowspan="2">Дефекти ДСП</td>
            <td colspan="3">за зміну</td>
            <td colspan="3">за місяць</td>
        </tr>
        <tr>
            <td><p style="font-size: small;">к-сть дефектів</p></td>
            <td><p style="font-size: small;">% від дефектів</p></td>
            <td><p style="font-size: small;">% від плити</p></td>
            <td><p style="font-size: small;">к-сть дефектів</p></td>
            <td><p style="font-size: small;">% від дефектів</p></td>
            <td><p style="font-size: small;">% від плити</p></td>
        </tr>
        {% for def in defDSP %}
        <tr>
            <td colspan="2">{{def}}</td>
            {% for i in range(1,15) %}
            <td><input type="text" name="t{{i}}" class="def_table_i t{{i}}i" size="7"></td>
            {% endfor %}
            <td><input type="text" class="def_tot_z def_tot_q t{{i}}i" size="10" readonly></td>
            <td><input type="text" class="def_tot_z def_tot_percd t{{i}}i" size="10" readonly></td>
            <td><input type="text" class="def_tot_z def_tot_percp t{{i}}i" size="10" readonly></td>
            <td><input type="text" class="def_tot_m def_tot_q t{{i}}i" size="10" readonly></td>
            <td><input type="text" class="def_tot_m def_tot_percd t{{i}}i" size="10" readonly></td>
            <td><input type="text" class="def_tot_m def_tot_percp t{{i}}i" size="10" readonly></td>
        </tr>
        {% endfor %}


    </table>

{% endblock body %}