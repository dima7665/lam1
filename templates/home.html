{% extends "layout.html" %}
{% block scripts %}
    <script>
        const koef = 0.08052;
        kk = {{rob_zm|tojson|safe}};

        function calculate_p_size(el)
        {
            calculate_size(el, "p");
            sum = calculate_perc(el, "plyta_q");

            n = document.querySelector("td[class="+tekst+"] input[class=zquantity]");
            n.value = sum / 2;
            calculate_size(n, "z");

            sum1s(el.className.slice(-8,-5), el.className.slice(-3,-1));
            sum_p(el.className.slice(-12,-10), el.className.slice(-3,-1));
        }

        function calculate_size(el, pos)
        {   
            if (pos == "z")
            {
                qEl = el.parentNode.parentNode.querySelector("input[class=i_z_size]");
                k = koef * 2;
            }
            if (pos == "p")
            {
                qEl = el.parentNode.parentNode.querySelector("input[class=i_p_size]");
                k = koef;
            }

            if (el.value != 0)
            {
                qEl.value = valRound4(el.value * k);
            } 
            else
            {
                qEl.value = "";
            }
        }

        function calculate_perc(el, pl)
        {
            tekst = el.parentNode.parentNode.className;
            n = document.querySelectorAll("."+tekst+"i."+pl); // all in column
            sum = sumVal(n);

            for (let elem of n)
            {
                if (sum > 0)
                { v = Math.round(elem.value / sum * 100) + "%";
                }
                else {
                    v = "";
                }
                elem.parentNode.parentNode.querySelector("input[class=i_p_perc]").value = v;
            }
            return sum;
        }

        function calculate_perc_1s(sum_1s, pr, e)
        {
            n = document.querySelectorAll("."+pr+"i."+e+"i.plyta_q");
            sumt = sumVal(n);
            if (sumt == 0)
            {
                res = "";
            }
            else
            {
                res = Math.round(sum_1s / sumt * 100) + "%";
            }
            return res;           
        }

        function pl_q_change()
        {
            calculate_p_size(event.target, "p");
        }

        function z_q_change()
        {
            calculate_size(event.target, "z");
        }

        
        function plyta_tot_change(s, e)
        {
            el = document.querySelector(".plyta_zm."+s+"i."+e+"i");
            calculate_size(el, "p");
            calculate_perc(el, "plyta_tot");
        }
       
            /* 
            let elements = document.querySelectorAll('ul > li:last-child');
            for (let elem of elements) {
                alert(elem.innerHTML); // "test", "passed"
            }

            [].indexOf.call(plytaInput, document.querySelector("input[id=t1s1i]"))
            */

        function valRound4(i)
        {
            return Math.round((i + Number.EPSILON) * 10000) / 10000
        }

        function sumVal(lst)
        {
            sum=0;
            for (i=0;i<lst.length;i++)
             {
                 if (lst[i].value != "")
                 {
                    sum += parseInt(lst[i].value);
                }
            }
            return sum;
        }

        function test()
        {   
            if (kk[1]=="")
            {
                alert(kk[1]);
            }
            
        }

        function calc_sum1s()
        {
            el = event.target;

        }

        function sum1s(pr, e)
        {   
            n = document.querySelectorAll(".s1i."+pr+"i."+e+"i.plyta_q");
            sum = sumVal(n);    // sum 1 sort
            document.querySelector(".total_i."+pr+"i."+e+"i").value = sum/2;
            document.querySelector(".size_i."+pr+"i."+e+"i").value = valRound4(sum * koef);
            // percent
            document.querySelector(".perc_i."+pr+"i."+e+"i").value = calculate_perc_1s(sum, pr, e);

        }

        function sum_p(s, e)
        {   
            n = document.querySelectorAll("."+s+"i."+e+"i.plyta_q");
            sum = sumVal(n);
            el = document.querySelector(".plyta_zm."+s+"i."+e+"i");
            el.value = sum;
            plyta_tot_change(s,e);
            sum_t(e, el.className.slice(-13,-9));

            // Разом
            n = document.querySelectorAll(".plyta_zm."+s+"i");
            sum = sumVal(n);
            el = document.querySelector(".plyta_zmt."+s+"i");
            el.value = sum;
            calculate_size(el, "p");
            calculate_perc(el, "plyta_tot");
            sum_t("e3", el.className.slice(-13,-9));
            // порахувати за добу
            // порахувати за місяць
            
        }

        function sum_t(e, t)
        {   
            n = document.querySelectorAll(".plyta_tot."+t+"i");
            sum = sumVal(n);
            el = document.querySelector("."+e+"i."+t+"i.zquantity");
            el.value = sum/2;
            calculate_size(el, "z");

        }

        function listen()
        {
            //var el = document.querySelector("div.user-panel.main input[name=login]")

            window.plytaInput = document.querySelectorAll(".plyta_q");
            
            // test label
            document.querySelector("label[class=testClick]").addEventListener("click",test,false);

            //document.querySelector(".total_i").addEventListener("change", calc_sum1s, false);

            for(let i=0; i<plytaInput.length;i++)
            {   
                calculate_p_size(plytaInput[i]);
                plytaInput[i].addEventListener("change", pl_q_change, false);
            }  
        }

        document.addEventListener('DOMContentLoaded', listen);


    </script>
{% endblock scripts %}

{% block body %}
    <input type="date" id="zm_date" value="2021-01-01">
    <label class="testClick">Click</label>
    <h2>Назва таблиці</h2>
    <p></p>
    <table id="main_table">  
        <tr id="row_header">
            <td colspan="2" rowspan="2">Випуск продукції</td>
            <td colspan="7">Прес1</td>
            <td colspan="7">Прес2</td>
            <td colspan="3">Всього Е1</td>
            <td colspan="3">Всього Е05</td>
            <td colspan="3">Разом</td>
        </tr>
        <tr id="row_E">
            <td colspan="4">Е1</td>
            <td colspan="3">Е05</td>
            <td colspan="4">Е1</td>
            <td colspan="3">Е05</td>
        </tr>
        <tr id="pidsumok">
            <td colspan="2">підсумок</td>
            <td><input type="text" class="pr1i e1i total_i" size="7" readonly></td>
            <td><input type="text" class="pr1i e1i size_i" size="7" readonly></td>
            <td><input type="text" class="pr1i e1i perc_i" size="7" readonly></td>
            <td></td>
            <td><input type="text" class="pr1i e2i total_i" size="7" readonly></td>
            <td><input type="text" class="pr1i e2i size_i" size="7" readonly></td>
            <td><input type="text" class="pr1i e2i perc_i" size="7" readonly></td>
            <td><input type="text" class="pr2i e1i total_i" size="7" readonly></td>
            <td><input type="text" class="pr2i e1i size_i" size="7" readonly></td>
            <td><input type="text" class="pr2i e1i perc_i" size="7" readonly></td>
            <td></td>
            <td><input type="text" class="pr2i e2i total_i" size="7" readonly></td>
            <td><input type="text" class="pr2i e2i size_i" size="7" readonly></td>
            <td><input type="text" class="pr2i e2i perc_i" size="7" readonly></td>
        </tr>
        <tr>
            <td colspan="2">Текстури</td>
            {% for i in range(14) %}
            <td><input type="text" name="texture" value="{{i}}" size="7"></td>
            {% endfor %}
        </tr>
        <tr id="s1">
            <td class='plyta'>Плита 1 сорт</td>
            <td><div>шт</div><div>м3</div><div>%</div></td>
            <td class="t1"><div><input type="text" id="t1s1i" class="plyta_q t1i s1i pr1i e1i" value="" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t2"><div><input type="text" id="t2s1i" class="plyta_q t2i s1i pr1i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t3"><div><input type="text" id="t3s1i" class="plyta_q t3i s1i pr1i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t4"><div><input type="text" id="t4s1i" class="plyta_q t4i s1i pr1i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t5"><div><input type="text" id="t5s1i" class="plyta_q t5i s1i pr1i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t6"><div><input type="text" id="t6s1i" class="plyta_q t6i s1i pr1i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t7"><div><input type="text" id="t7s1i" class="plyta_q t7i s1i pr1i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t8"><div><input type="text" id="t8s1i" class="plyta_q t8i s1i pr2i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t9"><div><input type="text" id="t9s1i" class="plyta_q t9i s1i pr2i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t10"><div><input type="text" id="t10s1i" class="plyta_q t10i s1i pr2i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t11"><div><input type="text" id="t11s1i" class="plyta_q t11i s1i pr2i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t12"><div><input type="text" id="t12s1i" class="plyta_q t12i s1i pr2i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t13"><div><input type="text" id="t13s1i" class="plyta_q t13i s1i pr2i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t14"><div><input type="text" id="t14s1i" class="plyta_q t14i s1i pr2i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot1"><div><input type="text" id="tote1s1z" class="plyta_zm plyta_tot tot1i s1i e1i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot2"><div><input type="text" id="tote1s1d" class="plyta_dob plyta_tot tot2i s1i e1i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot3"><div><input type="text" id="tote1s1m" class="plyta_mis plyta_tot tot3i s1i e1i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot4"><div><input type="text" id="tote2s1z" class="plyta_zm plyta_tot tot4i s1i e2i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot5"><div><input type="text" id="tote2s1d" class="plyta_dob plyta_tot tot5i s1i e2i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot6"><div><input type="text" id="tote2s1m" class="plyta_mis plyta_tot tot6i s1i e2i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot7"><div><input type="text" id="tots1z" class="plyta_zmt plyta_tot tot7i s1i e3i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot8"><div><input type="text" id="tots1d" class="plyta_dobt plyta_tot tot8i s1i e3i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot9"><div><input type="text" id="tots1m" class="plyta_mist plyta_tot tot9i s1i e3i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
             
        </tr>
        <tr id="s2">
            <td class='plyta'>Плита 2 сорт</td>
            <td><div>шт</div><div>м3</div><div>%</div></td>
            <td class="t1"><div><input type="text" id="t1s2i" class="plyta_q t1i s2i pr1i e1i" value="" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t2"><div><input type="text" id="t2s2i" class="plyta_q t2i s2i pr1i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t3"><div><input type="text" id="t3s2i" class="plyta_q t3i s2i pr1i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t4"><div><input type="text" id="t4s2i" class="plyta_q t4i s2i pr1i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t5"><div><input type="text" id="t5s2i" class="plyta_q t5i s2i pr1i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t6"><div><input type="text" id="t6s2i" class="plyta_q t6i s2i pr1i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t7"><div><input type="text" id="t7s2i" class="plyta_q t7i s2i pr1i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t8"><div><input type="text" id="t8s2i" class="plyta_q t8i s2i pr2i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t9"><div><input type="text" id="t9s2i" class="plyta_q t9i s2i pr2i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t10"><div><input type="text" id="t10s2i" class="plyta_q t10i s2i pr2i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t11"><div><input type="text" id="t11s2i" class="plyta_q t11i s2i pr2i e1i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t12"><div><input type="text" id="t12s2i" class="plyta_q t12i s2i pr2i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t13"><div><input type="text" id="t13s2i" class="plyta_q t13i s2i pr2i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="t14"><div><input type="text" id="t14s2i" class="plyta_q t14i s2i pr2i e2i" size="7"></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot1"><div><input type="text" id="tote1s2z" class="plyta_zm plyta_tot tot1i s2i e1i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot2"><div><input type="text" id="tote1s2d" class="plyta_dob plyta_tot tot2i s2i e1i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot3"><div><input type="text" id="tote1s2m" class="plyta_mis plyta_tot tot3i s2i e1i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot4"><div><input type="text" id="tote2s2z" class="plyta_zm plyta_tot tot4i s2i e2i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot5"><div><input type="text" id="tote2s2d" class="plyta_dob plyta_tot tot5i s2i e2i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot6"><div><input type="text" id="tote2s2m" class="plyta_mis plyta_tot tot6i s2i e2i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot7"><div><input type="text" id="tots2z" class="plyta_zmt plyta_tot tot7i s2i e3i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot8"><div><input type="text" id="tots2d" class="plyta_dobt plyta_tot tot8i s2i e3i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
            <td class="tot9"><div><input type="text" id="tots2m" class="plyta_mist plyta_tot tot9i s2i e3i" size="7" readonly></div>
                <div><input type="text" class="i_p_size" size="7" readonly></div>
                <div><input type="text" class="i_p_perc" size="7" readonly></div></td>
        </tr>
        <tr id="row_zapr">
            <td class='plyta'>Всього </td>
            <td><div>запр</div><div>м3</div></td>
            <td class="t1"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t2"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t3"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t4"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t5"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t6"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t7"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t8"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t9"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t10"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t11"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t12"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t13"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="t14"><div><input class="zquantity" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="tot1"><div><input class="zquantity tot1i e1i" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="tot1"><div><input class="zquantity tot2i e1i" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="tot1"><div><input class="zquantity tot3i e1i" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="tot1"><div><input class="zquantity tot4i e2i" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="tot1"><div><input class="zquantity tot5i e2i" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="tot1"><div><input class="zquantity tot6i e2i" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="tot1"><div><input class="zquantity tot7i e3i" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="tot1"><div><input class="zquantity tot8i e3i" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
            <td class="tot1"><div><input class="zquantity tot9i e3i" type="text" size="7" readonly></div>
                <div><input type="text" class="i_z_size" size="7" readonly></div>
        </tr>
    </table>
{% endblock body %}